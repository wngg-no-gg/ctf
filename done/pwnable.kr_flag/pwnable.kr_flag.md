# pwnable.kr_flag

é¢˜ç›®ç±»å‹ï¼šReverse

è‡ªå®šä¹‰éš¾åº¦ï¼šâ˜…â˜†â˜†â˜†â˜†

## 1 é¢˜ç›®

![image-20211120153228945](pwnable.kr_flag.assets/image-20211120153228945.png)

é™„ä»¶ï¼š[flag](pwnable.kr_flag.assets/flag)

## 2 è§£é¢˜

### 2.1 åˆ†æé¢˜ç›®

çœ‹é¢˜ç›®åº”è¯¥æ˜¯ä¸€é“é€†å‘é¢˜ï¼Œè¿è¡Œä¸€ä¸‹çœ‹çœ‹ï¼š

![image-20211120153528183](pwnable.kr_flag.assets/image-20211120153528183.png)

ä»…æ˜¯è¾“å‡ºäº†ä¸€æ®µè¯ï¼Œida é€†å‘çœ‹çœ‹ï¼Œä¸€çœ¼éš¾ï¼Œè¿˜æ˜¯å…ˆå­¦ä¸€ä¸‹é€†å‘é¢˜ç›®åŸºç¡€å§ã€‚[ctf-wiki reverse](https://ctf-wiki.org/reverse/introduction/)

æœç´¢å­—ç¬¦ä¸²ä¹Ÿæ²¡æœ‰æœåˆ°è¿è¡Œæ—¶æ‰“å°çš„å­—ç¬¦ä¸²ï¼Œåªæœ‰è¿™ä¸‰ä¸ªå­—ç¬¦ä¸²ã€‚

![image-20211120162904038](pwnable.kr_flag.assets/image-20211120162904038.png)

è¿™ä¸ª `upx.sf.net` åœ¨ä¹‹å‰ `checksec` æ—¶ä¹Ÿçœ‹åˆ°ç›¸å…³çš„ã€‚

![image-20211120163014417](pwnable.kr_flag.assets/image-20211120163014417.png)

Google ä¸€ä¸‹ UPXï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªåŠ å£³å™¨ï¼ŒGoogle ä¸€ä¸‹ UPX è„±å£³æŠ€å·§å§ã€‚

![image-20211120163144722](pwnable.kr_flag.assets/image-20211120163144722.png)

### 2.2 UPX è„±å£³ç»ƒæ‰‹

ä¸ºäº†å­¦ä¹ ä¸€ä¸‹è„±å£³æŠ€å·§ï¼Œæˆ‘ä»¬è‡ªå·±å†™ä¸ª `hello_world.c` ç¼–è¯‘åŠ å£³ååˆ†æä¸€ä¸‹ï¼Œç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ã€‚

```c
#include <stdio.h>

int main()
{
    printf("hello world!\n");
    return 0;
}
```

ç¼–è¯‘ï¼Œæ‰“åŒ…ï¼š

```bash
gcc --static -o hello_world hello_world.c
cp hello_world hello_world_upxed
upx hello_world_upxed
```

åŸºäºè¿™ä¸¤ä¸ªäºŒè¿›åˆ¶å­¦ä¹ ä¸€ä¸‹ upx è„±å£³æŠ€æœ¯ã€‚

![image-20211120172323515](pwnable.kr_flag.assets/image-20211120172323515.png)

![image-20211120172416785](pwnable.kr_flag.assets/image-20211120172416785.png)

ä¸Šè¿°åˆ†åˆ«ä¸º `hello_world` å’Œ `hello_world_upxed` é€†å‘å‡ºæ¥çš„æ ·å­ï¼Œå·®è·è¿˜æ˜¯éå¸¸å¤§çš„ï¼Œupx åŠ å£³åçš„é€†å‘ç»“æœå’Œé¢˜ç›®äºŒè¿›åˆ¶é€†å‘ç»“æœéå¸¸ç›¸ä¼¼ï¼Œçœ‹æ ·å­åº”è¯¥æ˜¯ä¸€ä¸ªè„±å£³é¢˜äº†ã€‚

**upx è„±å£³æŠ€å·§**

æœ¬èŠ‚ä»¥ `hello_world_upxed` ä¸ºä¾‹ã€‚

> UPX å…¶å®ç°å‹ç¼©çš„æ–¹æ³•æ˜¯åœ¨ç¨‹åºåŸå…ˆä»£ç ä¹‹å‰å†æ’å…¥ä¸€æ®µä»£ç ï¼Œå› æ­¤åœ¨åŠ å£³ç¨‹åºè¿è¡Œå‰è¿™æ®µä»£ç ä¼šå…ˆè¢«è¿è¡Œï¼Œå…¶ä½œç”¨åˆ™æ˜¯è§£å‹ç¼©åŠ å£³ç¨‹åºçš„ä»£ç åˆ°æŸä¸€å†…å­˜æ®µæˆ–ä¸´æ—¶æ–‡ä»¶ä¸Šï¼Œåœ¨å…¨éƒ¨è§£å‹ç¼©å®Œæ¯•åè·³è‡³è¯¥å†…å­˜æ®µæ‰§è¡Œç¨‹åºçš„çœŸæ­£ä»£ç ï¼Œé€šå¸¸çš„ï¼Œç§°è¿™ä¸ªå…¥å£ä¸ºOEPã€‚
>
> [upxå£³ä¸è„±å£³æŠ€å·§](http://www.qfrost.com/CTF/upx/)

upx æ˜¯ä¸€ç§å‹ç¼©å£³ï¼Œä¸å…·å¤‡åŠ å¯†èƒ½åŠ›ï¼Œå¯¹äºå®ƒçš„è„±å£³è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼ŒåŸºæœ¬çš„è„±å£³åŸç†å¯ä»¥å­¦ä¹ è¿™ç¯‡æ–‡ç« ï¼š[ã€æ–°æ‰‹æ•™ç¨‹ä¸‰ã€‘å°Zå¸¦ä½ å­¦ä¹ ä»€ä¹ˆæ˜¯ESPå®šå¾‹å’Œä»€ä¹ˆæ˜¯å †æ ˆå¹³è¡¡ ï¼Ÿ](https://www.52pojie.cn/thread-394116-1-1.html)ã€‚

![image-20211121120729194](pwnable.kr_flag.assets/image-20211121120729194.png)

ç¨‹åºå¼€å§‹çš„è¿™äº› push åº”ä¸ªå°±æ˜¯è¿›å…¥è§£å‹ä»£ç å‰çš„ä¿ç•™ç°åœºäº†ï¼Œgdb åœ¨ç¨‹åºå¼€å§‹å¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸€æ®µ push å®Œåçš„æ ˆåœ°å€ã€‚

```text
b *0x44a690
```

![image-20211121122101335](pwnable.kr_flag.assets/image-20211121122101335.png)

push å®Œåæ ˆé¡¶ `sp` ä¸º `0x7fffffffde18`ï¼Œç»™è¿™ä¸ªåœ°å€ä¸‹ä¸€ä¸ªè®¿é—®æ–­ç‚¹ï¼ˆæ•°æ®æ–­ç‚¹ã€ç¡¬ä»¶æ–­ç‚¹ï¼‰ã€‚

```text
watch *0x7fffffffde18
c
```

![image-20211121123012439](pwnable.kr_flag.assets/image-20211121123012439.png)

ç¬¬ä¸€æ¬¡è®¿é—®å¥½åƒä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¯•è¯•å† `c` ä¸€ä¸‹ã€‚	

![image-20211121123100548](pwnable.kr_flag.assets/image-20211121123100548.png)

è¿™ä¸€æ¬¡åº”è¯¥æ˜¯é¢„æœŸçš„ï¼Œæ ˆå†…å®¹å’Œä¸€å¼€å§‹ push çš„å†…å®¹ä¸€æ ·ã€‚ä½†æ˜¯ç»§ç»­å•æ­¥è¿è¡Œäº†å¾ˆä¹…ï¼Œè¿˜æ˜¯æ²¡æœ‰è¿›å…¥æ­£å¸¸çš„ç¨‹åºï¼Œéš¾é“åªæ˜¯ pop äº†ä¸Šé¢å‡ ä¸ªæ•°æ®ï¼Œå®é™…ä¸Šè¿˜æ˜¯åœ¨è§£å‹ç¨‹åºéƒ¨åˆ†ï¼Ÿç»§ç»­ watch æ›´æ·±çš„æ ˆåœ°å€çœ‹çœ‹ã€‚

emmï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°è§£å‹åçš„ä»£ç æ®µï¼Œå¥½åƒ 64 ä½çš„ upx ä¸æ”¯æŒä¸Šè¿°æ–¹æ³•ï¼ŸğŸ¤¡

ä¸è¿‡æˆ‘åœ¨æ±‡ç¼–ä»£ç é‡Œæ‰¾åˆ°äº†è¿™ä¸€æ®µåˆšå¥½å’Œä¸€å¼€å§‹ push é¡ºåºå¯¹åº”çš„ pop ä»£ç ã€‚

![image-20211121141848343](pwnable.kr_flag.assets/image-20211121141848343.png)

![image-20211121143640264](pwnable.kr_flag.assets/image-20211121143640264.png)

æ‰“ä¸ªæ–­ç‚¹è¯•è¯•ã€‚

```text
b *0x44a7bc
```

![image-20211121143932119](pwnable.kr_flag.assets/image-20211121143932119.png)

s äº†å‡ æ­¥ä¹‹åï¼Œè¿™é‡Œæœ‰ä¸ªå¾ˆå¯ç–‘çš„ `jmp` ï¼Œä» `0x44a95c` è·³åˆ°äº† `0x7ffff7ff7978`ï¼Œdump å‡ºæ¥æ‹–å…¥ ida çœ‹çœ‹ã€‚

```text
dump memory ~/temp/m0.dump 0x7ffff7ff7978 0x7ffff7ff9000
```

![image-20211121151203436](pwnable.kr_flag.assets/image-20211121151203436.png)

æœç´¢ä¸åˆ°å­—ç¬¦ä¸²ï¼Œåº”è¯¥ä¸æ˜¯è§£å‹åçš„ä»£ç ï¼Œå¯èƒ½è¿˜æœ‰ä¸€æ¬¡å¤§è·³è½¬ï¼Œgdbå•æ­¥ä¸€ç›´å¾ªç¯ï¼Œç»“åˆé™æ€ä»£ç ä¸€èµ·åˆ†æä¸€ä¸‹å§ã€‚

ï¼ˆdump å‡ºæ¥çš„æ±‡ç¼–ä»£ç å¯¹åº”åœ°å€æ˜¯åŸºäº `0x7ffff7ff7978` åœ°å€çš„åç§»ï¼Œå¯ä»¥é€šè¿‡ Edit -> Segments ->Rebase Program ä¿®æ”¹åŸºå€ï¼‰

OKï¼Œè¯•äº†åŠå¤©ï¼Œç»ˆäºæ”¾å¼ƒäº†ï¼Œç›´æ¥ç”¨ç°æœ‰çš„è„±å£³è½¯ä»¶å§ã€‚ğŸ¤—

```bash
upx -d flag
```

### 2.3 è„±å£³åè°ƒè¯•

è„±å£³åçœŸæ˜¯ä¸€ç›®äº†ç„¶é¸­ï¼Œæ ¹æ®æç¤ºï¼Œç›´æ¥å¯¹ `strcpy` æ‰“æ–­ç‚¹è¿è¡Œã€‚

```text
b strcpy
r
```

![image-20211121160833461](pwnable.kr_flag.assets/image-20211121160833461.png)

## 3 EXP

null

## 4 æ€»ç»“

1. é€†å‘é¢˜å…ˆåˆ©ç”¨æŸ¥å£³å™¨çœ‹çœ‹ï¼Œå¦‚ [Detect It Easy](https://github.com/horsicq/Detect-It-Easy)

## é™„å½•Aï¼šå‚è€ƒ

- [upxå£³ä¸è„±å£³æŠ€å·§](http://www.qfrost.com/CTF/upx/)
- [ã€æ–°æ‰‹æ•™ç¨‹ä¸‰ã€‘å°Zå¸¦ä½ å­¦ä¹ ä»€ä¹ˆæ˜¯ESPå®šå¾‹å’Œä»€ä¹ˆæ˜¯å †æ ˆå¹³è¡¡ ï¼Ÿ](https://www.52pojie.cn/thread-394116-1-1.html)